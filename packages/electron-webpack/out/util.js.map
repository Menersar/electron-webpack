{"version":3,"names":["BluebirdPromise","data","_interopRequireWildcard","require","_fsExtra","_net","path","_getRequireWildcardCache","nodeInterop","WeakMap","cacheBabelInterop","cacheNodeInterop","obj","__esModule","default","cache","has","get","newObj","hasPropertyDescriptor","Object","defineProperty","getOwnPropertyDescriptor","key","prototype","hasOwnProperty","call","desc","set","statOrNull","file","orNullIfFileNotExist","stat","promise","orIfFileNotExist","fallbackValue","catch","e","code","getFirstExistingFile","names","rootDir","filter","map","it","join","then","length","getFreePort","defaultHost","defaultPort","Promise","resolve","reject","server","createServer","pauseOnConnect","addListener","port","address","close","doListen","listen","host","backlog","exclusive","on"],"sources":["../src/util.ts"],"sourcesContent":["import * as BluebirdPromise from \"bluebird\"\nimport { stat, Stats } from \"fs-extra\"\nimport { createServer } from \"net\"\nimport * as path from \"path\"\n\nexport async function statOrNull(file: string): Promise<Stats | null> {\n  return orNullIfFileNotExist(stat(file))\n}\n\nexport function orNullIfFileNotExist<T>(promise: Promise<T>): Promise<T | null> {\n  return orIfFileNotExist(promise, null)\n}\n\nexport function orIfFileNotExist<T>(promise: Promise<T>, fallbackValue: T): Promise<T> {\n  return promise\n    .catch(e => {\n      if (e.code === \"ENOENT\" || e.code === \"ENOTDIR\") {\n        return fallbackValue\n      }\n      throw e\n    })\n}\n\nexport function getFirstExistingFile(names: Array<string>, rootDir: string | null): Promise<string | null> {\n  return BluebirdPromise.filter(names.map(it => rootDir == null ? it : path.join(rootDir, it)), it => statOrNull(it).then(it => it != null))\n    .then(it => it.length > 0 ? it[0] : null)\n}\n\nexport function getFreePort(defaultHost: string, defaultPort: number) {\n  return new Promise((resolve, reject) => {\n    const server = createServer({pauseOnConnect: true})\n    server.addListener(\"listening\", () => {\n      const port = (server.address() as any).port\n      server.close(() => resolve(port))\n    })\n\n    function doListen(port: number) {\n      server.listen({\n        host: defaultHost,\n        port,\n        backlog: 1,\n        exclusive: true\n      })\n    }\n\n    server.on(\"error\", e => {\n      if ((e as any).code === \"EADDRINUSE\") {\n        server.close(() => doListen(0))\n      }\n      else {\n        reject(e)\n      }\n    })\n\n    doListen(defaultPort)\n  })\n}"],"mappings":";;;;;;;;;;AAAA,SAAAA,gBAAA;EAAA,MAAAC,IAAA,GAAAC,uBAAA,CAAAC,OAAA;EAAAH,eAAA,YAAAA,CAAA;IAAA,OAAAC,IAAA;EAAA;EAAA,OAAAA,IAAA;AAAA;AACA,SAAAG,SAAA;EAAA,MAAAH,IAAA,GAAAE,OAAA;EAAAC,QAAA,YAAAA,CAAA;IAAA,OAAAH,IAAA;EAAA;EAAA,OAAAA,IAAA;AAAA;AACA,SAAAI,KAAA;EAAA,MAAAJ,IAAA,GAAAE,OAAA;EAAAE,IAAA,YAAAA,CAAA;IAAA,OAAAJ,IAAA;EAAA;EAAA,OAAAA,IAAA;AAAA;AACA,IAAAK,IAAA,GAAAJ,uBAAA,CAAAC,OAAA;AAA4B,SAAAI,yBAAAC,WAAA,eAAAC,OAAA,kCAAAC,iBAAA,OAAAD,OAAA,QAAAE,gBAAA,OAAAF,OAAA,YAAAF,wBAAA,YAAAA,CAAAC,WAAA,WAAAA,WAAA,GAAAG,gBAAA,GAAAD,iBAAA,KAAAF,WAAA;AAAA,SAAAN,wBAAAU,GAAA,EAAAJ,WAAA,SAAAA,WAAA,IAAAI,GAAA,IAAAA,GAAA,CAAAC,UAAA,WAAAD,GAAA,QAAAA,GAAA,oBAAAA,GAAA,wBAAAA,GAAA,4BAAAE,OAAA,EAAAF,GAAA,UAAAG,KAAA,GAAAR,wBAAA,CAAAC,WAAA,OAAAO,KAAA,IAAAA,KAAA,CAAAC,GAAA,CAAAJ,GAAA,YAAAG,KAAA,CAAAE,GAAA,CAAAL,GAAA,SAAAM,MAAA,WAAAC,qBAAA,GAAAC,MAAA,CAAAC,cAAA,IAAAD,MAAA,CAAAE,wBAAA,WAAAC,GAAA,IAAAX,GAAA,QAAAW,GAAA,kBAAAH,MAAA,CAAAI,SAAA,CAAAC,cAAA,CAAAC,IAAA,CAAAd,GAAA,EAAAW,GAAA,SAAAI,IAAA,GAAAR,qBAAA,GAAAC,MAAA,CAAAE,wBAAA,CAAAV,GAAA,EAAAW,GAAA,cAAAI,IAAA,KAAAA,IAAA,CAAAV,GAAA,IAAAU,IAAA,CAAAC,GAAA,KAAAR,MAAA,CAAAC,cAAA,CAAAH,MAAA,EAAAK,GAAA,EAAAI,IAAA,YAAAT,MAAA,CAAAK,GAAA,IAAAX,GAAA,CAAAW,GAAA,SAAAL,MAAA,CAAAJ,OAAA,GAAAF,GAAA,MAAAG,KAAA,IAAAA,KAAA,CAAAa,GAAA,CAAAhB,GAAA,EAAAM,MAAA,YAAAA,MAAA;AAErB,eAAeW,UAAUA,CAACC,IAAY;EAC3C,OAAOC,oBAAoB,CAAC,IAAAC,eAAI,EAACF,IAAI,CAAC,CAAC;AACzC;AAEM,SAAUC,oBAAoBA,CAAIE,OAAmB;EACzD,OAAOC,gBAAgB,CAACD,OAAO,EAAE,IAAI,CAAC;AACxC;AAEM,SAAUC,gBAAgBA,CAAID,OAAmB,EAAEE,aAAgB;EACvE,OAAOF,OAAO,CACXG,KAAK,CAACC,CAAC,IAAG;IACT,IAAIA,CAAC,CAACC,IAAI,KAAK,QAAQ,IAAID,CAAC,CAACC,IAAI,KAAK,SAAS,EAAE;MAC/C,OAAOH,aAAa;;IAEtB,MAAME,CAAC;EACT,CAAC,CAAC;AACN;AAEM,SAAUE,oBAAoBA,CAACC,KAAoB,EAAEC,OAAsB;EAC/E,OAAOzC,eAAe,CAAf,CAAe,CAAC0C,MAAM,CAACF,KAAK,CAACG,GAAG,CAACC,EAAE,IAAIH,OAAO,IAAI,IAAI,GAAGG,EAAE,GAAGtC,IAAI,CAACuC,IAAI,CAACJ,OAAO,EAAEG,EAAE,CAAC,CAAC,EAAEA,EAAE,IAAIf,UAAU,CAACe,EAAE,CAAC,CAACE,IAAI,CAACF,EAAE,IAAIA,EAAE,IAAI,IAAI,CAAC,CAAC,CACvIE,IAAI,CAACF,EAAE,IAAIA,EAAE,CAACG,MAAM,GAAG,CAAC,GAAGH,EAAE,CAAC,CAAC,CAAC,GAAG,IAAI,CAAC;AAC7C;AAEM,SAAUI,WAAWA,CAACC,WAAmB,EAAEC,WAAmB;EAClE,OAAO,IAAIC,OAAO,CAAC,CAACC,OAAO,EAAEC,MAAM,KAAI;IACrC,MAAMC,MAAM,GAAG,IAAAC,mBAAY,EAAC;MAACC,cAAc,EAAE;IAAI,CAAC,CAAC;IACnDF,MAAM,CAACG,WAAW,CAAC,WAAW,EAAE,MAAK;MACnC,MAAMC,IAAI,GAAIJ,MAAM,CAACK,OAAO,EAAU,CAACD,IAAI;MAC3CJ,MAAM,CAACM,KAAK,CAAC,MAAMR,OAAO,CAACM,IAAI,CAAC,CAAC;IACnC,CAAC,CAAC;IAEF,SAASG,QAAQA,CAACH,IAAY;MAC5BJ,MAAM,CAACQ,MAAM,CAAC;QACZC,IAAI,EAAEd,WAAW;QACjBS,IAAI;QACJM,OAAO,EAAE,CAAC;QACVC,SAAS,EAAE;OACZ,CAAC;IACJ;IAEAX,MAAM,CAACY,EAAE,CAAC,OAAO,EAAE7B,CAAC,IAAG;MACrB,IAAKA,CAAS,CAACC,IAAI,KAAK,YAAY,EAAE;QACpCgB,MAAM,CAACM,KAAK,CAAC,MAAMC,QAAQ,CAAC,CAAC,CAAC,CAAC;OAChC,MACI;QACHR,MAAM,CAAChB,CAAC,CAAC;;IAEb,CAAC,CAAC;IAEFwB,QAAQ,CAACX,WAAW,CAAC;EACvB,CAAC,CAAC;AACJ"}
