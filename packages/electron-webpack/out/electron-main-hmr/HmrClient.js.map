{"version":3,"names":["_crocket","data","_interopRequireDefault","require","obj","__esModule","default","debug","HmrClient","constructor","socketPath","hot","currentHashGetter","lastHash","ipc","Crocket","Error","connect","path","error","console","stack","toString","enabled","on","hash","isUpToDate","status","check","warn","then","outdatedModules","log","catch","app","exit","message"],"sources":["../../src/electron-main-hmr/HmrClient.ts"],"sourcesContent":["import Crocket from \"crocket\"\n\nconst debug = require(\"debug\")(\"electron-webpack:main-client-hmr\")\n\ninterface BuiltMessage {\n  hash: string\n}\n\nexport class HmrClient {\n  lastHash: string | null = null\n\n  private readonly ipc = new Crocket()\n\n  constructor(socketPath: string, private hot: __WebpackModuleApi.Hot, private readonly currentHashGetter: () => string) {\n    if (hot == null) {\n      throw new Error(`[HMR] Hot Module Replacement is disabled.`)\n    }\n\n    this.ipc.connect({path: socketPath}, error => {\n      if (error != null) {\n        console.error(error.stack || error.toString())\n      }\n      if (debug.enabled) {\n        debug(`Connected to server (${socketPath})`)\n      }\n    })\n\n    this.ipc.on<Error>(\"error\", error => {\n      console.error(error.stack || error.toString())\n    })\n\n    this.ipc.on<BuiltMessage>(\"/built\", data => {\n      this.lastHash = data.hash\n      if (this.isUpToDate()) {\n        if (debug.enabled) {\n          debug(`Up to date, hash ${data.hash}`)\n        }\n        return\n      }\n\n      const status = hot.status()\n      if (status === \"idle\") {\n        this.check()\n      }\n      else if (status === \"abort\" || status === \"fail\") {\n        console.warn(`[HMR] Cannot apply update as a previous update ${status}ed. Need to do a full reload!`)\n      }\n      else if (debug.enabled) {\n        debug(`Cannot check changes, status ${status}`)\n      }\n    })\n  }\n\n  private isUpToDate() {\n    return this.lastHash === this.currentHashGetter()\n  }\n\n  private check() {\n    this.hot.check(true)\n      .then(outdatedModules => {\n        if (outdatedModules == null) {\n          console.warn(`[HMR] Cannot find update. Need to do a full reload!`)\n          console.warn(`[HMR] (Probably because of restarting the webpack-dev-server)`)\n          return\n        }\n\n        require(\"webpack/hot/log-apply-result\")(outdatedModules, outdatedModules)\n\n        if (this.isUpToDate()) {\n          console.log(`[HMR] App is up to date.`)\n        }\n      })\n      .catch(error => {\n        const status = this.hot.status()\n        if (status === \"abort\" || status === \"fail\") {\n          console.warn(`[HMR] ${error.stack || error.toString()}`)\n          console.warn(\"[HMR] Cannot apply update. Need to do a full reload - application will be restarted\")\n          require(\"electron\").app.exit(100)\n        }\n        else {\n          console.warn(`[HMR] Update failed: ${error.stack || error.message}`)\n        }\n      })\n  }\n}"],"mappings":"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"}
