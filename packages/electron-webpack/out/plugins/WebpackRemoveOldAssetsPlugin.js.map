{"version":3,"names":["bluebird","data","_interopRequireWildcard","require","_fsExtra","path","_util","_getRequireWildcardCache","nodeInterop","WeakMap","cacheBabelInterop","cacheNodeInterop","obj","__esModule","default","cache","has","get","newObj","hasPropertyDescriptor","Object","defineProperty","getOwnPropertyDescriptor","key","prototype","hasOwnProperty","call","desc","set","MAX_FILE_REQUESTS","exports","CONCURRENCY","concurrency","debug","walk","initialDirPath","filter","result","queue","addDirToResult","length","dirPath","pop","childNames","orNullIfFileNotExist","readdir","push","sort","dirs","sortedFilePaths","map","name","filePath","sep","lstat","then","stat","isDirectory","child","WebpackRemoveOldAssetsPlugin","constructor","dllManifest","apply","compiler","hooks","afterEmit","tapAsync","compilation","callback","newlyCreatedAssets","assets","outDir","options","output","file","relativePath","substring","isFile","p","keys","startsWith","it","enabled","join","remove","catch"],"sources":["../../src/plugins/WebpackRemoveOldAssetsPlugin.ts"],"sourcesContent":["import * as bluebird from \"bluebird\"\nimport { lstat, readdir, remove, Stats } from \"fs-extra\"\nimport * as path from \"path\"\nimport { Compiler } from \"webpack\"\nimport { orNullIfFileNotExist } from \"../util\"\n\nexport const MAX_FILE_REQUESTS = 8\nexport const CONCURRENCY = {concurrency: MAX_FILE_REQUESTS}\n\nconst debug = require(\"debug\")(\"electron-webpack:clean\")\n\nexport async function walk(initialDirPath: string, filter?: Filter | null): Promise<Array<string>> {\n  const result: Array<string> = []\n  const queue: Array<string> = [initialDirPath]\n  let addDirToResult = false\n  while (queue.length > 0) {\n    const dirPath = queue.pop()!\n\n    const childNames = await orNullIfFileNotExist(readdir(dirPath))\n    if (childNames == null) {\n      continue\n    }\n\n    if (addDirToResult) {\n      result.push(dirPath)\n    }\n    else {\n      addDirToResult = true\n    }\n\n    childNames.sort()\n\n    const dirs: Array<string> = []\n    // our handler is async, but we should add sorted files, so, we add file to result not in the mapper, but after map\n    const sortedFilePaths = await bluebird.map(childNames, name => {\n      const filePath = dirPath + path.sep + name\n      return lstat(filePath)\n        .then(stat => {\n          if (filter != null && !filter(filePath, stat)) {\n            return null\n          }\n\n          if (stat.isDirectory()) {\n            dirs.push(name)\n            return null\n          }\n          else {\n            return filePath\n          }\n        })\n    }, CONCURRENCY)\n\n    for (const child of sortedFilePaths) {\n      if (child != null) {\n        result.push(child)\n      }\n    }\n\n    dirs.sort()\n    for (const child of dirs) {\n      queue.push(dirPath + path.sep + child)\n    }\n  }\n\n  return result\n}\n\nexport type Filter = (file: string, stat: Stats) => boolean\n\nexport class WebpackRemoveOldAssetsPlugin {\n  constructor(private readonly dllManifest: string | null) {\n  }\n\n  apply(compiler: Compiler) {\n    compiler.hooks.afterEmit.tapAsync(\"WebpackRemoveOldAssetsPlugin\", (compilation: any, callback: (error?: Error) => void) => {\n      const newlyCreatedAssets = compilation.assets\n      const outDir = compiler.options.output!.path!\n      walk(outDir, (file, stat) => {\n        // dll plugin\n        if (file === this.dllManifest) {\n          return false\n        }\n\n        const relativePath = file.substring(outDir.length + 1)\n        if (stat.isFile()) {\n          return newlyCreatedAssets[relativePath] == null\n        }\n        else if (stat.isDirectory()) {\n          for (const p of Object.keys(newlyCreatedAssets)) {\n            if (p.length > relativePath.length && (p[relativePath.length] === \"/\" || p[relativePath.length] === \"\\\\\") && p.startsWith(relativePath)) {\n              return false\n            }\n          }\n          return true\n        }\n        return false\n      })\n        .then((it): any => {\n          if (it.length === 0) {\n            return null\n          }\n\n          if (debug.enabled) {\n            debug(`Remove outdated files:\\n  ${it.join(\"\\n  \")}`)\n          }\n          return bluebird.map(it, it => remove(it), CONCURRENCY)\n        })\n        .then(() => callback())\n        .catch(callback)\n    })\n  }\n}\n"],"mappings":"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"}
